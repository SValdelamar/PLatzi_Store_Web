{% extends 'base.html' %}
{% load static %}

{% block title %}Editar Producto{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-wrapper">
        <h2 class="form-title">Editar Producto</h2>

        <form id="editar-producto-form">
            {% csrf_token %}
            <div id="alert-message"></div>

            <div class="form-group">
                <label for="title">Nombre del producto</label>
                <input type="text" name="title" id="title" value="{{ producto.title }}" required>
            </div>

            <div class="form-group">
                <label for="price">Precio del producto</label>
                <input type="number" step="0.01" name="price" id="price" value="{{ producto.price }}" required>
            </div>

            <div class="form-group">
                <label for="description">Descripción del producto</label>
                <textarea name="description" id="description" rows="4" required>{{ producto.description }}</textarea>
            </div>
            
            <div class="form-group">
                <label for="images">URL de la imagen del producto</label>
                <input type="url" name="images" id="images" value="{{ producto.images.0 }}" readonly>
            </div>

            <input type="hidden" id="product-id" value="{{ producto.id }}">

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submit-btn">Guardar Cambios</button>
                <a href="{% url 'products:products' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('editar-producto-form').addEventListener('submit', function(event) {
        event.preventDefault();

        const alertDiv = document.getElementById('alert-message');
        const submitBtn = document.getElementById('submit-btn');
        const productId = document.getElementById('product-id').value;

        // Asegúrate de que las claves del objeto coincidan con lo que espera tu vista
        // y la API de Platzi (title, price, description).
        const productData = {
            title: document.getElementById('title').value,
            price: document.getElementById('price').value,
            description: document.getElementById('description').value,
        };

        submitBtn.disabled = true;
        submitBtn.textContent = 'Guardando...';
        alertDiv.innerHTML = '';

        fetch(`/api/products/${productId}/editar/`, {
            method: 'PUT',
            body: JSON.stringify(productData),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (!response.ok) {
                // Si la respuesta no es OK, intenta leer el error del JSON de la respuesta
                return response.json().then(errorData => {
                    throw new Error(errorData.error || `Error desconocido: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alertDiv.innerHTML = '<div class="alert alert-success" role="alert">Producto actualizado exitosamente. Redirigiendo...</div>';
                setTimeout(() => {
                    window.location.href = "{% url 'products:products' %}";
                }, 2000);
            } else {
                alertDiv.innerHTML = `<div class="alert alert-danger" role="alert">Error: ${data.error}</div>`;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Cambios';
            }
        })
        .catch(error => {
            alertDiv.innerHTML = `<div class="alert alert-danger" role="alert">Error de conexión: ${error.message}</div>`;
            submitBtn.disabled = false;
            submitBtn.textContent = 'Guardar Cambios';
            console.error('Error:', error);
        });
    });
</script>
{% endblock %}